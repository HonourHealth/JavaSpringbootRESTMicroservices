<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/docker-compose/DOCKER_FIX_SUMMARY.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/docker-compose/DOCKER_FIX_SUMMARY.md" />
              <option name="updatedContent" value="# Docker MySQL Health Check Fix - Summary&#10;&#10;## Problem&#10;When running `docker compose up -d`, the MySQL database containers (accountsdb, loansdb, cardsdb) were failing health checks and reporting as &quot;unhealthy&quot;, causing dependent microservices to fail to start.&#10;&#10;Error message:&#10;```&#10;dependency failed to start: container loansdb is unhealthy&#10;```&#10;&#10;## Root Causes Identified&#10;&#10;### 1. **Missing Authentication in Health Check**&#10;The original health check command was:&#10;```yaml&#10;test: [ &quot;CMD&quot;, &quot;mysqladmin&quot; ,&quot;ping&quot;, &quot;-h&quot;, &quot;localhost&quot; ]&#10;```&#10;&#10;This failed because MySQL requires authentication when `MYSQL_ROOT_PASSWORD` is set.&#10;&#10;### 2. **Insufficient `start_period` for MySQL Initialization**&#10;- MySQL 8.0 takes approximately 2-3 minutes to fully initialize on first startup&#10;- The original `start_period: 10s` was way too short&#10;- MySQL initialization includes:&#10;  - Database file initialization (~1-2 minutes)&#10;  - InnoDB initialization (~30-40 seconds)&#10;  - Creating system databases and users (~30 seconds)&#10;  - Starting the actual MySQL server (~10-20 seconds)&#10;&#10;### 3. **Platform Compatibility Issues**&#10;Running MySQL containers on Windows/Mac without explicit platform specification can cause slower emulation.&#10;&#10;## Solutions Applied&#10;&#10;### All Configuration Files Updated&#10;- `docker-compose/qa/common-config.yml`&#10;- `docker-compose/default/common-config.yml`&#10;- `docker-compose/prod/common-config.yml`&#10;&#10;### Changes Made:&#10;&#10;```yaml&#10;microservice-db-config:&#10;  extends:&#10;    service: network-deploy-service&#10;  image: mysql:8.0                    # ✓ Use MySQL 8.0 instead of latest (9.x is too new/slow)&#10;  platform: linux/amd64                # ✓ Explicit platform for better compatibility&#10;  healthcheck:&#10;    test: [ &quot;CMD&quot;, &quot;mysqladmin&quot;, &quot;ping&quot;, &quot;-h&quot;, &quot;localhost&quot;, &quot;-u&quot;, &quot;root&quot;, &quot;-proot&quot; ]  # ✓ Added auth&#10;    timeout: 10s&#10;    retries: 10&#10;    interval: 10s&#10;    start_period: 120s                # ✓ Increased from 10s to 120s (2 minutes)&#10;  environment:&#10;    MYSQL_ROOT_PASSWORD: root&#10;  command: --default-authentication-plugin=mysql_native_password  # ✓ Better compatibility&#10;```&#10;&#10;## Key Changes Explained&#10;&#10;### 1. Health Check Authentication&#10;**Before:**&#10;```yaml&#10;test: [ &quot;CMD&quot;, &quot;mysqladmin&quot; ,&quot;ping&quot;, &quot;-h&quot;, &quot;localhost&quot; ]&#10;```&#10;&#10;**After:**&#10;```yaml&#10;test: [ &quot;CMD&quot;, &quot;mysqladmin&quot;, &quot;ping&quot;, &quot;-h&quot;, &quot;localhost&quot;, &quot;-u&quot;, &quot;root&quot;, &quot;-proot&quot; ]&#10;```&#10;- Added `-u root` for username&#10;- Added `-proot` for password (note: no space after -p)&#10;&#10;### 2. Start Period Increase&#10;**Before:** `start_period: 10s`  &#10;**After:** `start_period: 120s`&#10;&#10;The `start_period` gives MySQL time to initialize before health checks count as failures:&#10;- During the start_period, failed health checks don't count towards the retry limit&#10;- After 120 seconds, health checks begin counting towards the 10 retry limit&#10;- This prevents premature &quot;unhealthy&quot; status during initialization&#10;&#10;### 3. MySQL Version Pinning&#10;**Before:** `image: mysql` (pulls latest, which is 9.5.0)  &#10;**After:** `image: mysql:8.0`&#10;&#10;MySQL 9.x is very new and has longer initialization times. MySQL 8.0 is:&#10;- More stable&#10;- Faster to initialize&#10;- Better tested with Spring Boot applications&#10;- Industry standard version&#10;&#10;### 4. Platform Specification&#10;**Added:** `platform: linux/amd64`&#10;&#10;Benefits:&#10;- Ensures consistent behavior across different host platforms&#10;- Prevents slow emulation on ARM-based systems&#10;- Improves compatibility&#10;&#10;### 5. Authentication Plugin&#10;**Added:** `command: --default-authentication-plugin=mysql_native_password`&#10;&#10;- Ensures compatibility with older MySQL clients&#10;- Prevents authentication issues with Spring Boot applications&#10;- Standard practice for Spring Boot + MySQL integration&#10;&#10;## How to Use&#10;&#10;### Option 1: Manual Start&#10;```bash&#10;cd docker-compose/qa&#10;docker compose down -v&#10;docker compose up -d&#10;```&#10;&#10;**Wait 2-3 minutes** for MySQL containers to initialize fully before checking status:&#10;```bash&#10;docker ps&#10;```&#10;&#10;### Option 2: Using the Helper Script&#10;```powershell&#10;cd docker-compose/qa&#10;.\start-containers.ps1&#10;```&#10;&#10;This script:&#10;- Cleans up existing containers&#10;- Starts all containers&#10;- Monitors initialization progress&#10;- Provides status updates&#10;- Shows final health check results&#10;&#10;## Verification&#10;&#10;### Check Container Health:&#10;```bash&#10;docker ps --format &quot;table {{.Names}}\t{{.Status}}&quot;&#10;```&#10;&#10;Expected output (after 2-3 minutes):&#10;```&#10;NAMES                       STATUS&#10;accounts-microservice       Up X minutes&#10;loans-microservice          Up X minutes&#10;cards-microservice          Up X minutes&#10;accountsdb                  Up X minutes (healthy)&#10;loansdb                     Up X minutes (healthy)&#10;cardsdb                     Up X minutes (healthy)&#10;configserver-microservice   Up X minutes (healthy)&#10;```&#10;&#10;### Check MySQL is Responding:&#10;```bash&#10;docker exec accountsdb mysqladmin ping -h localhost -u root -proot&#10;```&#10;&#10;Expected output:&#10;```&#10;mysqld is alive&#10;```&#10;&#10;### View Container Logs:&#10;```bash&#10;docker logs accountsdb&#10;docker logs loansdb&#10;docker logs cardsdb&#10;```&#10;&#10;Look for:&#10;```&#10;[Note] [Entrypoint]: MySQL init process done. Ready for start up.&#10;[Server] /usr/sbin/mysqld: ready for connections.&#10;```&#10;&#10;## Troubleshooting&#10;&#10;### If containers remain unhealthy after 3 minutes:&#10;&#10;1. **Check MySQL logs:**&#10;   ```bash&#10;   docker logs accountsdb --tail 50&#10;   ```&#10;&#10;2. **Manually test MySQL connection:**&#10;   ```bash&#10;   docker exec accountsdb mysql -u root -proot -e &quot;SELECT 1&quot;&#10;   ```&#10;&#10;3. **Check available system resources:**&#10;   ```bash&#10;   docker stats&#10;   ```&#10;   MySQL needs adequate CPU and memory to initialize.&#10;&#10;4. **Increase start_period if on slow hardware:**&#10;   Edit `common-config.yml` and change:&#10;   ```yaml&#10;   start_period: 120s  # Try 180s or 240s&#10;   ```&#10;&#10;5. **Clean restart:**&#10;   ```bash&#10;   docker compose down -v  # -v removes volumes for fresh start&#10;   docker system prune -f  # Clean up Docker system&#10;   docker compose up -d&#10;   ```&#10;&#10;## Timeline Expectations&#10;&#10;- **0-30s:** Containers start, config server becomes healthy&#10;- **30-90s:** MySQL databases initialize (InnoDB, system databases)&#10;- **90-120s:** MySQL servers start accepting connections&#10;- **120-180s:** Health checks pass, containers marked as healthy&#10;- **180s+:** Microservices start and connect to databases&#10;&#10;## Summary&#10;&#10;The fix involves three key changes:&#10;1. ✅ Add authentication to MySQL health check command&#10;2. ✅ Increase `start_period` to 120 seconds to accommodate initialization time&#10;3. ✅ Use MySQL 8.0 with explicit platform specification for better performance and compatibility&#10;&#10;These changes ensure MySQL containers have adequate time to initialize before being marked as unhealthy, allowing dependent microservices to start successfully.&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>